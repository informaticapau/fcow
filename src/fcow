#!/bin/bash

##
# fcow - command
#
# @author Bruno Castro Garcia
# @author Angel Ruiz Fernandez
#
# @version 1.1
# @since May 2022


VERSION=1.1
LOG="/usr/local/share/fcow/LOG"

### "Pre-program"
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
	cat "/usr/local/share/fcow/HELP" |lolcat
	exit
elif [[ "$1" == "-v" || "$1" == "--version" ]]; then
	echo $VERSION |lolcat
	exit
elif [[ "$1" == "-l" || "$1" == "--log" ]]; then
	echo 'fcow log file in '$LOG':' |lolcat
	cat /usr/local/share/fcow/LOG |grep --color -n .
	exit
elif [[  "$1" == "--clear-log" ]]; then
	echo -n >/usr/local/share/fcow/LOG
	echo "Ok!" |lolcat
	exit
elif [[ "$1" == "-i" || "$1" == "--index" ]]; then
	raw=$(sed -n "$2,$2p" $LOG)
	if [[ -z $raw ]]; then
		echo "No index found" |lolcat
		exit
	fi;

	raw=$(echo "$raw" |base64 -d |gunzip)
	readarray -d : -t iarr <<< "$raw"
	echo "${iarr[0]}" |cow${iarr[2]} -f ${iarr[1]} ${bdgpstwy[3]} |lolcat
	exit
fi;


### Actual program

# Defaults
cowfile="default"
sot="say"
bdgpstwy=""

while [[ "$#" -gt 0 ]]; do
	case $1 in
		-r|--random)
			# Get path of cow files
			COWS=$(cowsay -l |grep "Cow files in " |awk 'match($0,/\/.*\/[^ ]*/){print substr($0,RSTART,RLENGTH-1)}')

			# Override defaults to RANDOM stuff
			cowfile=$(ls $COWS/*.cow |shuf -n 1)
			cowfile=$(basename $cowfile)
			sot=$(echo -ne "say\nthink" |shuf -n 1)
			#bdgpstwy="-bdgpstwy"
		shift;;

		# Future options
	esac
	shift
done;


### GO!
OUTPUT=$(fortune -ea)
echo "$OUTPUT" |cow$sot -f $cowfile $bdgpstwy |lolcat

### Save to LOG
OUT64=$(echo -n "$OUTPUT:$cowfile:$sot:$bdgpstwy" |gzip -cf |base64 -w0)
echo "$OUT64" >> $LOG
